name: ðŸ§¹ Lint

on:
  workflow_call:
    inputs:
      pnpm-cache-key:
        description: "The generated pnpm cache key"
        required: true
        type: string
      node-version:
        description: "Node.js version"
        required: false
        default: "22"
        type: string
      pnpm-version:
        description: "pnpm version"
        required: false
        default: "10.6.4"
        type: string
    secrets:
      NX_CLOUD_ACCESS_TOKEN:
        description: "Nx Cloud access token"
        required: true
    outputs:
      lint-summary:
        description: "Lint summary"
        value: ${{ jobs.lint.outputs.lint-summary }}

jobs:
  lint:
    name: ðŸ§¹ Lint
    runs-on: ubuntu-latest
    env:
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
    outputs:
      lint-summary: ${{ steps.lint-summary.outputs.lint-summary }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important: Need full history

      - name: ðŸ§® Calculate Nx Base and Head
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: 'main'

      - name: ðŸ› ï¸ Setup Environment
        run: |
          echo "::group::ðŸ“¦ Setup pnpm"
          npm install -g pnpm@${{ inputs.pnpm-version }}
          echo "::endgroup::"
          
          echo "::group::ðŸŸ¢ Setup Node.js"
          NODE_VERSION=${{ inputs.node-version }}
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm install $NODE_VERSION
          nvm use $NODE_VERSION
          echo "::endgroup::"

      # Restore dependency cache
      - name: ðŸ“š Restore dependency cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ inputs.pnpm-cache-key }}

      # Install dependencies if cache miss
      - name: ðŸ“¥ Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

      # Run lint with the SHAs set by nx-set-shas
      - name: ðŸ§¹ Run linting
        id: run-lint
        run: |
          echo "ðŸ” Running lint on affected projects..."
          echo "Using base: $NX_BASE"
          echo "Using head: $NX_HEAD"

          pnpm nx affected --target=lint --head=${{ env.NX_HEAD }} --base=${{ env.NX_BASE }} --parallel=3 --output-style=stream > lint_output.txt
          lint_exit_code=$?
          echo "âœ… Lint completed with exit code: $lint_exit_code"
          echo "lint_exit_code=$lint_exit_code" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Generate Lint Summary
        id: lint-summary
        run: |
          echo "LINT_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "## ðŸ§¹ Lint Results" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          if [ "${{ steps.run-lint.outputs.lint_exit_code }}" == "0" ]; then
            echo "âœ… Lint passed successfully" >> $GITHUB_ENV
          else
            echo "âŒ Lint failed" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "### Lint Output" >> $GITHUB_ENV
            echo "\`\`\`" >> $GITHUB_ENV
            cat lint_output.txt >> $GITHUB_ENV
            echo "\`\`\`" >> $GITHUB_ENV
          fi
          echo "EOF" >> $GITHUB_ENV

      - name: ðŸ“ Output Lint Summary
        run: |
          echo "${{ env.LINT_SUMMARY }}" >> $GITHUB_STEP_SUMMARY
          echo "lint-summary=${{ env.LINT_SUMMARY }}" >> $GITHUB_OUTPUT

      - name: ðŸš¨ Check Lint Status
        if: steps.run-lint.outputs.lint_exit_code != 0
        run: exit 1