name: 🚀 CI Pipeline

on:
  push:
    branches: [main, development, release/*]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:
    inputs:
      cache-version:
        description: "Cache version"
        required: false
        type: string
        default: "v1"
      node-version:
        description: "Node.js version"
        required: false
        type: string
        default: "22"
      pnpm-version:
        description: "pnpm version"
        required: false
        type: string
        default: "10.6.4"

jobs:
  setup:
    name: 🧰 Setup
    uses: ./.github/workflows/lib/setup.yml
    with:
      cache-version: ${{ inputs.cache-version || 'v1' }}
      node-version: ${{ inputs.node-version || '22' }}
      pnpm-version: ${{ inputs.pnpm-version || '10.6.4' }}
      sparse-checkout: false
    secrets:
      GH_TOKEN: ${{ secrets.GH_PAT }}

  build-npmrc:
    name: 📦 Build .npmrc
    needs: setup
    uses: ./.github/workflows/lib/configure-npmrc.yml
    secrets:
      inherit

  lint:
    name: 🧹 Lint
    needs: setup
    uses: ./.github/workflows/lib/lint.yml
    with:
      node-version: ${{ inputs.node-version || '22' }}
      pnpm-version: ${{ inputs.pnpm-version || '10.6.4' }}
      pnpm-cache-key: ${{ needs.setup.outputs.pnpm-cache-key }}
    secrets:
      inherit

  test:
    name: 🧪 Test
    needs: setup
    uses: ./.github/workflows/lib/test.yml
    with:
      node-version: ${{ inputs.node-version || '22' }}
      pnpm-version: ${{ inputs.pnpm-version || '10.6.4' }}
      pnpm-cache-key: ${{ needs.setup.outputs.pnpm-cache-key }}
      run-affected: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || false }}
      upload-coverage: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || false }}
    secrets:
      inherit

  build:
    name: 🏗️ Build
    needs: [setup]
    uses: ./.github/workflows/lib/build.yml
    with:
      node-version: ${{ inputs.node-version || '22' }}
      pnpm-version: ${{ inputs.pnpm-version || '10.6.4' }}
      pnpm-cache-key: ${{ needs.setup.outputs.pnpm-cache-key }}
    secrets: inherit

  release:
    name: 🚀 Release
    if: ${{ github.pull_request.merged == true && github.base_ref == 'main' && startsWith(github.head_ref, 'release/') }}
    needs: [lint, test, build]
    uses: ./.github/workflows/lib/release.yml
    with:
      node-version: ${{ inputs.node-version || '22' }}
      pnpm-version: ${{ inputs.pnpm-version || '10.6.4' }}
      pnpm-cache-key: ${{ needs.setup.outputs.pnpm-cache-key }}
      build-cache-key: ${{ needs.build.outputs.build-cache-key }}
      build-artifact-key: ${{ needs.build.outputs.build-artifact-key }}
      coverage-artifact-key: ${{ needs.test.outputs.coverage-artifact-key }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GH_PAT }}
      NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}


