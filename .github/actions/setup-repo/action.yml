name: "ðŸ“¦ Setup Repository Checkout"
description: "Performs sparse or full checkout and conditionally configures Nx Cloud"
author: "Terry Lee Allen, Jr"

inputs:
  sparse-checkout:
    description: "Enable sparse checkout for faster cloning"
    required: false
    default: 'false'

outputs:
  branch:
    description: "The current Git branch"
    value: ${{ steps.repo-meta.outputs.branch }}
  commit:
    description: "The current Git commit SHA"
    value: ${{ steps.repo-meta.outputs.commit }}
  sparse-checkout-used:
    description: "Whether sparse checkout was enabled"
    value: ${{ inputs.sparse-checkout }}

runs:
  using: "composite"
  steps:

    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
        token: ${{ env.GH_PAT }}
        sparse-checkout: ${{ inputs.sparse-checkout == 'true' && 'package.json pnpm-lock.yaml nx.json tsconfig.json .github apps libs' || '' }}
        sparse-checkout-cone-mode: false

    - name: ðŸ§¾ Capture Repository Metadata
      id: repo-meta
      shell: bash
      run: |
        echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
        echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: ðŸ“Š Checkout Summary
      shell: bash
      env:
        BRANCH: ${{ steps.repo-meta.outputs.branch }}
        COMMIT: ${{ steps.repo-meta.outputs.commit }}
        SPARSE: ${{ inputs.sparse-checkout }}
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
        echo "â”ƒ                    ðŸ“¦ Repository Setup Summary                        â”ƒ"
        echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«"
        echo "â”ƒ â€¢ Branch: ${BRANCH}" 
        echo "â”ƒ â€¢ Commit: ${COMMIT}" 
        echo "â”ƒ â€¢ Sparse Checkout Used: ${SPARSE}" 
        echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"

        echo "## ðŸ“¦ Repository Setup Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${BRANCH}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${COMMIT}" >> $GITHUB_STEP_SUMMARY
        echo "- **Sparse Checkout:** ${SPARSE}" >> $GITHUB_STEP_SUMMARY